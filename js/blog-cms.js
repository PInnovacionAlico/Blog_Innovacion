/* ==================================================
   JAVASCRIPT DEL CMS DEL BLOG
   Funcionalidades de administraci√≥n y gesti√≥n
   ================================================== */

class BlogCMS {
    constructor() {
        this.isAuthenticated = false;
        this.currentUser = null;
        this.init();
    }
    
    init() {
        this.checkAuthentication();
        this.setupCMSEvents();
    }
    
    checkAuthentication() {
        // Verificar si el usuario est√° autenticado con Netlify Identity
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (user) {
                    this.isAuthenticated = true;
                    this.currentUser = user;
                    this.showCMSButton();
                    console.log('‚úÖ Usuario autenticado:', user.email);
                } else {
                    this.isAuthenticated = false;
                    this.currentUser = null;
                    this.hideCMSButton();
                    console.log('‚ÑπÔ∏è Usuario no autenticado');
                }
            });
            
            window.netlifyIdentity.on("login", user => {
                this.isAuthenticated = true;
                this.currentUser = user;
                this.showCMSButton();
                console.log('üîê Usuario logueado:', user.email);
            });
            
            window.netlifyIdentity.on("logout", () => {
                this.isAuthenticated = false;
                this.currentUser = null;
                this.hideCMSButton();
                console.log('üö™ Usuario deslogueado');
            });
        }
    }
    
    setupCMSEvents() {
        // Event listener para el bot√≥n de administraci√≥n
        document.addEventListener('click', (e) => {
            if (e.target.closest('.cms-button')) {
                e.preventDefault();
                this.openCMS();
            }
        });
    }
    
    showCMSButton() {
        const cmsAdmin = document.getElementById('cmsAdmin');
        if (cmsAdmin) {
            cmsAdmin.style.display = 'block';
        }
    }
    
    hideCMSButton() {
        const cmsAdmin = document.getElementById('cmsAdmin');
        if (cmsAdmin) {
            cmsAdmin.style.display = 'none';
        }
    }
    
    openCMS() {
        if (!this.isAuthenticated) {
            this.showLoginModal();
            return;
        }
        
        // Abrir el CMS de Netlify
        if (window.netlifyIdentity) {
            window.netlifyIdentity.open('cms');
        } else {
            // Fallback: abrir en nueva ventana
            window.open('/admin', '_blank');
        }
    }
    
    showLoginModal() {
        const modal = document.createElement('div');
        modal.className = 'cms-login-modal';
        modal.innerHTML = `
            <div class="cms-modal-content">
                <div class="cms-modal-header">
                    <h3>Acceso al CMS</h3>
                    <button class="cms-modal-close" onclick="this.closest('.cms-login-modal').remove()">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div class="cms-modal-body">
                    <p>Para acceder al panel de administraci√≥n del blog, debes iniciar sesi√≥n.</p>
                    <button class="cms-login-btn" onclick="blogCMS.login()">
                        <span class="material-symbols-rounded">login</span>
                        Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Cerrar modal al hacer clic fuera
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
    
    login() {
        if (window.netlifyIdentity) {
            window.netlifyIdentity.open('login');
        }
    }
    
    // M√©todos para gesti√≥n de contenido
    async createPost(postData) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            // En un entorno real, esto enviar√≠a los datos al CMS
            console.log('üìù Creando nuevo post:', postData);
            
            // Simular creaci√≥n exitosa
            return {
                success: true,
                postId: Date.now(),
                message: 'Post creado exitosamente'
            };
        } catch (error) {
            console.error('Error creando post:', error);
            throw error;
        }
    }
    
    async updatePost(postId, postData) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            console.log('‚úèÔ∏è Actualizando post:', postId, postData);
            
            // Simular actualizaci√≥n exitosa
            return {
                success: true,
                message: 'Post actualizado exitosamente'
            };
        } catch (error) {
            console.error('Error actualizando post:', error);
            throw error;
        }
    }
    
    async deletePost(postId) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            console.log('üóëÔ∏è Eliminando post:', postId);
            
            // Simular eliminaci√≥n exitosa
            return {
                success: true,
                message: 'Post eliminado exitosamente'
            };
        } catch (error) {
            console.error('Error eliminando post:', error);
            throw error;
        }
    }
    
    // M√©todos para gesti√≥n de usuarios
    getCurrentUser() {
        return this.currentUser;
    }
    
    getUserRole() {
        if (!this.currentUser) return 'guest';
        
        // En un entorno real, esto vendr√≠a del backend
        // Por ahora, simulamos roles basados en el email
        if (this.currentUser.email.includes('admin')) return 'admin';
        if (this.currentUser.email.includes('editor')) return 'editor';
        return 'author';
    }
    
    canEditPosts() {
        const role = this.getUserRole();
        return ['admin', 'editor', 'author'].includes(role);
    }
    
    canDeletePosts() {
        const role = this.getUserRole();
        return ['admin', 'editor'].includes(role);
    }
    
    canManageUsers() {
        const role = this.getUserRole();
        return role === 'admin';
    }
    
    // M√©todos para estad√≠sticas del blog
    async getBlogStats() {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            // En un entorno real, esto vendr√≠a del backend
            return {
                totalPosts: 6,
                publishedPosts: 6,
                draftPosts: 0,
                totalViews: 1250,
                totalComments: 45,
                lastUpdated: new Date().toISOString()
            };
        } catch (error) {
            console.error('Error obteniendo estad√≠sticas:', error);
            throw error;
        }
    }
    
    // M√©todos para gesti√≥n de categor√≠as
    async getCategories() {
        return [
            { id: 'innovacion', name: 'Innovaci√≥n', count: 1 },
            { id: 'sostenibilidad', name: 'Sostenibilidad', count: 2 },
            { id: 'tecnologia', name: 'Tecnolog√≠a', count: 2 },
            { id: 'proyectos', name: 'Proyectos', count: 1 }
        ];
    }
    
    async createCategory(categoryData) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            console.log('üè∑Ô∏è Creando categor√≠a:', categoryData);
            return { success: true, categoryId: Date.now() };
        } catch (error) {
            console.error('Error creando categor√≠a:', error);
            throw error;
        }
    }
    
    // M√©todos para gesti√≥n de im√°genes
    async uploadImage(file) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            console.log('üì∏ Subiendo imagen:', file.name);
            
            // Simular subida exitosa
            return {
                success: true,
                imageUrl: URL.createObjectURL(file),
                imageId: Date.now()
            };
        } catch (error) {
            console.error('Error subiendo imagen:', error);
            throw error;
        }
    }
    
    // M√©todos para gesti√≥n de comentarios
    async getComments(postId) {
        // En un entorno real, esto vendr√≠a del backend
        return [
            {
                id: 1,
                author: 'Juan P√©rez',
                content: 'Excelente art√≠culo sobre sostenibilidad',
                date: '2024-01-16T10:30:00Z',
                approved: true
            }
        ];
    }
    
    async approveComment(commentId) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            console.log('‚úÖ Aprobando comentario:', commentId);
            return { success: true };
        } catch (error) {
            console.error('Error aprobando comentario:', error);
            throw error;
        }
    }
    
    async deleteComment(commentId) {
        if (!this.isAuthenticated) {
            throw new Error('Usuario no autenticado');
        }
        
        try {
            console.log('üóëÔ∏è Eliminando comentario:', commentId);
            return { success: true };
        } catch (error) {
            console.error('Error eliminando comentario:', error);
            throw error;
        }
    }
}

// Inicializar el CMS
let blogCMS;

document.addEventListener('DOMContentLoaded', function() {
    blogCMS = new BlogCMS();
    console.log('üîß CMS del blog inicializado');
});

// Funci√≥n global para abrir el CMS
function openCMS() {
    if (blogCMS) {
        blogCMS.openCMS();
    }
}

// Para debugging
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.debugCMS = {
        cms: () => blogCMS,
        login: () => blogCMS?.login(),
        createPost: (data) => blogCMS?.createPost(data),
        updatePost: (id, data) => blogCMS?.updatePost(id, data),
        deletePost: (id) => blogCMS?.deletePost(id),
        getStats: () => blogCMS?.getBlogStats(),
        getUserRole: () => blogCMS?.getUserRole()
    };
    console.log('üöÄ Debug CMS disponible en window.debugCMS');
}
